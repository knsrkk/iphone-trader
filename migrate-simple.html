<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è Firebase ‚Üí Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
            text-align: center;
        }
        
        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #007AFF;
        }
        
        .step h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .progress {
            margin: 30px 0;
            display: none;
        }
        
        .progress-bar {
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056cc;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .logs {
            margin-top: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
            font-family: monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .time {
            color: #888;
            margin-right: 10px;
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• ‚Üí üü¢ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h1>
        <p class="description">–ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase Firestore –≤ Supabase</p>
        
        <div class="step">
            <h3>üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
            <p>–ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ <b>Supabase SQL Editor</b>:</p>
            <pre style="background: #1a1a1a; color: #4CAF50; padding: 15px; border-radius: 8px; margin: 10px 0; overflow-x: auto; font-size: 13px;">-- –ò–∑–º–µ–Ω—è–µ–º —Ç–∏–ø auth_uid –Ω–∞ TEXT (Firebase UID –Ω–µ UUID)
ALTER TABLE users ALTER COLUMN auth_uid TYPE TEXT;
ALTER TABLE users ALTER COLUMN auth_uid DROP NOT NULL;</pre>
            <p style="margin-top: 15px;">–¢–∞–∫–∂–µ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:</p>
            <ul style="margin-left: 20px; margin-top: 10px; color: #666;">
                <li>–¢–∞–±–ª–∏—Ü—ã –≤ Supabase —Å–æ–∑–¥–∞–Ω—ã (users, products, parts)</li>
                <li>–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Firebase –ø—Ä–æ–µ–∫—Ç—É</li>
                <li>–í—ã –ø–æ–ª—É—á–∏–ª–∏ <b>service_role</b> –∫–ª—é—á –∏–∑ Supabase (–ù–ï anon key!)</li>
            </ul>
        </div>
        
        <div class="step">
            <h3>üîë –ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞</h3>
            
            <div class="input-group">
                <label for="firebaseConfig">Firebase Config JSON:</label>
                <textarea id="firebaseConfig" rows="8"></textarea>
                <small style="color: #888; display: block; margin-top: 5px;">
                    –ì–¥–µ –≤–∑—è—Ç—å: Firebase Console ‚Üí Project Settings ‚Üí General ‚Üí Your apps ‚Üí SDK setup ‚Üí Config<br>
                    –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ–±—ä–µ–∫—Ç <code>firebaseConfig</code> —Ü–µ–ª–∏–∫–æ–º (–≤–∫–ª—é—á–∞—è —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏)
                </small>
            </div>
            
            <div class="input-group">
                <label for="supabaseUrl">Supabase URL:</label>
                <input type="text" id="supabaseUrl" 
                       value="https://ooihrxpzbzdkrwhyizgb.supabase.co"
                       placeholder="https://xxx.supabase.co">
            </div>
            
            <div class="input-group">
                <label for="serviceKey">Supabase Service Role Key:</label>
                <input type="password" id="serviceKey" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ service_role –∫–ª—é—á">
                <small style="color: #888; display: block; margin-top: 5px;">
                    –ù–∞–π—Ç–∏: Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role (–ù–ï anon key!)
                </small>
            </div>
        </div>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">–ì–æ—Ç–æ–≤–æ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏</div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-primary" id="startBtn">
                üöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
            </button>
            <button class="btn btn-secondary" id="testBtn">
                üîç –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </button>
            <button class="btn btn-secondary" id="exampleBtn">
                üìã –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
            </button>
        </div>
        
        <div class="buttons" style="margin-top: 15px;">
            <button class="btn" id="clearBtn" style="background: #f44336; color: white;">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å Supabase
            </button>
        </div>
        
        <div class="logs" id="logs">
            <div id="logContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const startBtn = document.getElementById('startBtn');
        const testBtn = document.getElementById('testBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logs = document.getElementById('logs');
        const logContent = document.getElementById('logContent');
        const firebaseConfigInput = document.getElementById('firebaseConfig');
        const serviceKeyInput = document.getElementById('serviceKey');
        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const exampleBtn = document.getElementById('exampleBtn');
        
        let supabaseClient = null;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
        exampleBtn.addEventListener('click', () => {
            const exampleConfig = `{
  "apiKey": "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "authDomain": "your-project.firebaseapp.com",
  "projectId": "your-project",
  "storageBucket": "your-project.firebasestorage.app",
  "messagingSenderId": "123456789012",
  "appId": "1:123456789012:web:abcdef1234567890"
}`;
            firebaseConfigInput.value = exampleConfig;
            firebaseConfigInput.style.borderColor = '#ff9800';
            alert('–≠—Ç–æ –ü–†–ò–ú–ï–†! –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Console.');
        });
        
        // –û—á–∏—Å—Ç–∏—Ç—å Supabase
        const clearBtn = document.getElementById('clearBtn');
        clearBtn.addEventListener('click', async () => {
            const serviceKey = serviceKeyInput.value.trim();
            const supabaseUrl = supabaseUrlInput.value.trim();
            
            if (!supabaseUrl || !serviceKey) {
                alert('–í–≤–µ–¥–∏—Ç–µ Supabase URL –∏ Service Role Key!');
                return;
            }
            
            const confirmed = confirm(
                '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase:\n\n' +
                '‚Ä¢ –í—Å–µ —Ç–æ–≤–∞—Ä—ã (products)\n' +
                '‚Ä¢ –í—Å–µ –∑–∞–ø—á–∞—Å—Ç–∏ (parts)\n' +
                '‚Ä¢ –í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (users)\n\n' +
                '–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û —É–¥–∞–ª–µ–Ω—ã!\n\n' +
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã?'
            );
            
            if (!confirmed) return;
            
            const doubleConfirmed = confirm(
                'üî¥ –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n' +
                '–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?\n\n' +
                '–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.'
            );
            
            if (!doubleConfirmed) return;
            
            try {
                clearBtn.disabled = true;
                clearBtn.textContent = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';
                
                log('warning', 'üóëÔ∏è –ù–∞—á–∏–Ω–∞—é –æ—á–∏—Å—Ç–∫—É Supabase...');
                
                supabaseClient = supabase.createClient(supabaseUrl, serviceKey);
                
                // –£–¥–∞–ª—è–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–∏–∑-–∑–∞ foreign keys)
                // –°–Ω–∞—á–∞–ª–∞ products –∏ parts (–æ–Ω–∏ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ users)
                
                log('info', 'üóëÔ∏è –£–¥–∞–ª—è—é —Ç–æ–≤–∞—Ä—ã...');
                const { error: productsError } = await supabaseClient
                    .from('products')
                    .delete()
                    .gte('id', 0); // –£–¥–∞–ª—è–µ–º –í–°–ï –∑–∞–ø–∏—Å–∏ –≥–¥–µ id >= 0
                
                if (productsError) {
                    log('warning', `‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤: ${productsError.message}`);
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
                    log('info', 'üîÑ –ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±...');
                    const { data: allProducts } = await supabaseClient.from('products').select('id');
                    if (allProducts && allProducts.length > 0) {
                        for (const p of allProducts) {
                            await supabaseClient.from('products').delete().eq('id', p.id);
                        }
                        log('success', `‚úÖ –£–¥–∞–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${allProducts.length}`);
                    }
                } else {
                    log('success', '‚úÖ –¢–æ–≤–∞—Ä—ã —É–¥–∞–ª–µ–Ω—ã');
                }
                
                log('info', 'üóëÔ∏è –£–¥–∞–ª—è—é –∑–∞–ø—á–∞—Å—Ç–∏...');
                const { error: partsError } = await supabaseClient
                    .from('parts')
                    .delete()
                    .gte('id', 0);
                
                if (partsError) {
                    log('warning', `‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π: ${partsError.message}`);
                    const { data: allParts } = await supabaseClient.from('parts').select('id');
                    if (allParts && allParts.length > 0) {
                        for (const p of allParts) {
                            await supabaseClient.from('parts').delete().eq('id', p.id);
                        }
                        log('success', `‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø—á–∞—Å—Ç–µ–π: ${allParts.length}`);
                    }
                } else {
                    log('success', '‚úÖ –ó–∞–ø—á–∞—Å—Ç–∏ —É–¥–∞–ª–µ–Ω—ã');
                }
                
                log('info', 'üóëÔ∏è –£–¥–∞–ª—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                const { error: usersError } = await supabaseClient
                    .from('users')
                    .delete()
                    .gte('id', 0);
                
                if (usersError) {
                    log('warning', `‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersError.message}`);
                    const { data: allUsers } = await supabaseClient.from('users').select('id');
                    if (allUsers && allUsers.length > 0) {
                        for (const u of allUsers) {
                            await supabaseClient.from('users').delete().eq('id', u.id);
                        }
                        log('success', `‚úÖ –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${allUsers.length}`);
                    }
                } else {
                    log('success', '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å—ë —É–¥–∞–ª–µ–Ω–æ
                const { data: checkProducts } = await supabaseClient.from('products').select('id');
                const { data: checkParts } = await supabaseClient.from('parts').select('id');
                const { data: checkUsers } = await supabaseClient.from('users').select('id');
                
                log('info', `üìä –û—Å—Ç–∞–ª–æ—Å—å: —Ç–æ–≤–∞—Ä–æ–≤=${checkProducts?.length || 0}, –∑–∞–ø—á–∞—Å—Ç–µ–π=${checkParts?.length || 0}, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π=${checkUsers?.length || 0}`);
                
                log('success', 'üéâ Supabase –æ—á–∏—â–µ–Ω!');
                alert('‚úÖ Supabase —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω!');
                
            } catch (error) {
                log('error', `üí• –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${error.message}`);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                clearBtn.disabled = false;
                clearBtn.textContent = 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å Supabase';
            }
        });
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(type, message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="time">${time}</span> <span class="${type}">${message}</span>`;
            
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            logs.style.display = 'block';
            
            // –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log(`[${time}] ${message}`);
        }
        
        function updateProgress(percent, text) {
            progress.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        testBtn.addEventListener('click', async () => {
            const serviceKey = serviceKeyInput.value.trim();
            const supabaseUrl = supabaseUrlInput.value.trim();
            
            if (!supabaseUrl) {
                alert('–í–≤–µ–¥–∏—Ç–µ Supabase URL!');
                return;
            }
            
            if (!serviceKey) {
                alert('–í–≤–µ–¥–∏—Ç–µ service_role –∫–ª—é—á!');
                return;
            }
            
            try {
                log('info', 'üîó –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...');
                log('info', `üìç URL: ${supabaseUrl}`);
                
                supabaseClient = supabase.createClient(supabaseUrl, serviceKey);
                
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ç–µ—Å—Ç–∞
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                } else {
                    log('success', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!');
                }
                
            } catch (error) {
                log('error', `üí• –û—à–∏–±–∫–∞: ${error.message}`);
            }
        });
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
        startBtn.addEventListener('click', async () => {
            const firebaseConfigStr = firebaseConfigInput.value.trim();
            const serviceKey = serviceKeyInput.value.trim();
            const supabaseUrl = supabaseUrlInput.value.trim();
            
            if (!firebaseConfigStr) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ Firebase!');
                return;
            }
            
            if (!supabaseUrl) {
                alert('–í–≤–µ–¥–∏—Ç–µ Supabase URL!');
                return;
            }
            
            if (!serviceKey) {
                alert('–í–≤–µ–¥–∏—Ç–µ service_role –∫–ª—é—á Supabase!');
                return;
            }
            
            try {
                // –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ñ–∏–≥ Firebase
                let firebaseConfig;
                try {
                    firebaseConfig = JSON.parse(firebaseConfigStr);
                } catch (jsonError) {
                    log('error', '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –≤ –∫–æ–Ω—Ñ–∏–≥–µ Firebase!');
                    log('error', `–û—à–∏–±–∫–∞: ${jsonError.message}`);
                    log('info', 'üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –≤–µ—Å—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ Firebase Console');
                    log('info', 'üí° Firebase Console ‚Üí Project Settings ‚Üí General ‚Üí Your apps ‚Üí Config');
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ Firebase.\n\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –∏–∑ Firebase Console ‚Üí Project Settings ‚Üí Config');
                    startBtn.disabled = false;
                    startBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é';
                    testBtn.disabled = false;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    log('error', '‚ùå –í –∫–æ–Ω—Ñ–∏–≥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (apiKey, projectId)');
                    alert('–í –∫–æ–Ω—Ñ–∏–≥–µ Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                    return;
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                startBtn.disabled = true;
                startBtn.textContent = '‚è≥ –ú–∏–≥—Ä–∞—Ü–∏—è...';
                testBtn.disabled = true;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                updateProgress(5, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...');
                log('info', 'üöÄ –ù–∞—á–∏–Ω–∞—é –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
                supabaseClient = supabase.createClient(supabaseUrl, serviceKey);
                log('info', `‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω (${supabaseUrl})`);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase SDK –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                log('info', 'üì¶ –ó–∞–≥—Ä—É–∂–∞—é Firebase SDK...');
                
                // –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º CDN —Å script —Ç–µ–≥–∞–º–∏
                await loadFirebaseSDK();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                
                log('success', '‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateProgress(20, 'Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                await migrateAllData(db, supabaseClient);
                
                // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                updateProgress(100, '–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                log('success', 'üéâ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!');
                
                startBtn.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                
            } catch (error) {
                log('error', `üí• –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ${error.message}`);
                startBtn.disabled = false;
                startBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é';
                testBtn.disabled = false;
            }
        });
        
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Firebase SDK
        function loadFirebaseSDK() {
            return new Promise((resolve, reject) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ Firebase
                if (window.firebase) {
                    log('info', 'Firebase —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    resolve();
                    return;
                }
                
                log('info', '–ó–∞–≥—Ä—É–∂–∞—é Firebase SDK...');
                
                // –°–æ–∑–¥–∞–µ–º script —Ç–µ–≥–∏
                const scripts = [
                    'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
                    'https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js'
                ];
                
                let loaded = 0;
                
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        loaded++;
                        if (loaded === scripts.length) {
                            log('success', '‚úÖ Firebase SDK –∑–∞–≥—Ä—É–∂–µ–Ω');
                            resolve();
                        }
                    };
                    script.onerror = () => {
                        log('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${src}`);
                        reject(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${src}`));
                    };
                    document.head.appendChild(script);
                });
            });
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
        async function migrateAllData(db, supabase) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã users
            log('info', 'üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã users...');
            
            // 1. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            log('info', 'üë• –ò—â—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Firebase...');
            
            const usersSnapshot = await db.collection('users').get();
            log('info', `üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersSnapshot.size}`);
            
            // –ú–∞–ø –¥–ª—è —Å–≤—è–∑–∏ Firebase uid ‚Üí Supabase id
            const userMap = {};
            let userIndex = 0;
            
            for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                const firebaseUid = userData.uid || userDoc.id;
                const userEmail = userData.email || `user_${userIndex}@migrated.local`;
                const userName = userData.name || userEmail.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ email
                    const { data: existingUser, error: selectError } = await supabase
                        .from('users')
                        .select('id, auth_uid')
                        .eq('email', userEmail)
                        .maybeSingle();
                    
                    if (selectError && selectError.message.includes('uuid')) {
                        log('error', '‚ùå –ö–æ–ª–æ–Ω–∫–∞ auth_uid –∏–º–µ–µ—Ç —Ç–∏–ø UUID!');
                        log('error', 'üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:');
                        log('error', 'ALTER TABLE users ALTER COLUMN auth_uid TYPE TEXT;');
                        throw new Error('–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏ auth_uid –Ω–∞ TEXT');
                    }
                    
                    if (existingUser) {
                        userMap[firebaseUid] = existingUser.id;
                        log('info', `‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${userEmail} (id: ${existingUser.id})`);
                    } else {
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–ï–ó auth_uid (–æ—Å—Ç–∞–≤–∏–º null)
                        // auth_uid –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ Supabase Auth
                        const supabaseUser = {
                            name: userName,
                            email: userEmail,
                            is_admin: userData.isAdmin || false
                        };
                        
                        const { data, error } = await supabase
                            .from('users')
                            .insert([supabaseUser])
                            .select()
                            .single();
                        
                        if (error) {
                            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ email, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏
                            if (error.message.includes('duplicate') || error.message.includes('unique')) {
                                const { data: existingByEmail } = await supabase
                                    .from('users')
                                    .select('id')
                                    .eq('email', userEmail)
                                    .single();
                                if (existingByEmail) {
                                    userMap[firebaseUid] = existingByEmail.id;
                                    log('info', `‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –ø–æ email: ${userEmail}`);
                                    userIndex++;
                                    continue;
                                }
                            }
                            log('warning', `‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userEmail}: ${error.message}`);
                        } else {
                            userMap[firebaseUid] = data.id;
                            log('success', `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userEmail} (id: ${data.id})`);
                        }
                    }
                } catch (error) {
                    log('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail}: ${error.message}`);
                    if (error.message.includes('auth_uid')) {
                        throw error; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∏–ø–æ–º –∫–æ–ª–æ–Ω–∫–∏
                    }
                }
                
                userIndex++;
                updateProgress(20 + (userIndex / usersSnapshot.size * 15), 
                              `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${userIndex}/${usersSnapshot.size}`);
            }
            
            log('info', `üìã –ö–∞—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${Object.keys(userMap).length} –∑–∞–ø–∏—Å–µ–π`);
            
            // 2. –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
            log('info', 'üì¶ –ò—â—É —Ç–æ–≤–∞—Ä—ã –≤ Firebase...');
            const productsSnapshot = await db.collection('products').get();
            log('info', `üìä –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${productsSnapshot.size}`);
            
            let productIndex = 0;
            let productsAdded = 0;
            let productsSkipped = 0;
            
            for (const productDoc of productsSnapshot.docs) {
                const productData = productDoc.data();
                
                // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π user_id –∏–∑ –Ω–∞—à–µ–≥–æ –º–∞–ø–∞
                const firebaseUserId = productData.userId || productData.user_id;
                const supabaseUserId = userMap[firebaseUserId];
                
                if (!supabaseUserId) {
                    log('warning', `‚ö†Ô∏è –¢–æ–≤–∞—Ä "${productData.name}" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${firebaseUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    productsSkipped++;
                    productIndex++;
                    continue;
                }
                
                // –ù–ï —É–∫–∞–∑—ã–≤–∞–µ–º id - –ø—É—Å—Ç—å Supabase –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º
                const supabaseProduct = {
                    user_id: supabaseUserId,
                    name: productData.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    description: productData.description || '',
                    purchase_price: parseFloat(productData.purchasePrice) || parseFloat(productData.purchase_price) || 0,
                    investment: parseFloat(productData.investment) || 0,
                    selling_price: parseFloat(productData.sellingPrice) || parseFloat(productData.selling_price) || null,
                    category: productData.category || 'phones',
                    phone_status: productData.phoneStatus || productData.phone_status || null,
                    purchase_source: productData.purchaseSource || productData.purchase_source || null,
                    status: productData.status || 'in-stock',
                    photos: productData.photos || [],
                    required_parts: productData.requiredParts || productData.required_parts || '',
                    sold_at: productData.soldAt?.toDate?.()?.toISOString() || productData.sold_at || null,
                    sale_source: productData.saleSource || productData.sale_source || null,
                    sale_notes: productData.saleNotes || productData.sale_notes || '',
                    change_history: productData.changeHistory || productData.change_history || [],
                    created_at: productData.createdAt?.toDate?.()?.toISOString() || new Date().toISOString(),
                    last_updated: new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from('products')
                        .insert([supabaseProduct])
                        .select()
                        .single();
                    
                    if (error) {
                        log('warning', `‚ö†Ô∏è –¢–æ–≤–∞—Ä "${productData.name}": ${error.message}`);
                        productsSkipped++;
                    } else {
                        log('success', `‚úÖ –¢–æ–≤–∞—Ä: ${productData.name} (id: ${data.id})`);
                        productsAdded++;
                    }
                } catch (error) {
                    log('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–æ–≤–∞—Ä–∞ "${productData.name}": ${error.message}`);
                    productsSkipped++;
                }
                
                productIndex++;
                updateProgress(40 + (productIndex / productsSnapshot.size * 35), 
                              `–¢–æ–≤–∞—Ä—ã: ${productIndex}/${productsSnapshot.size}`);
            }
            
            log('info', `üìä –¢–æ–≤–∞—Ä—ã: –¥–æ–±–∞–≤–ª–µ–Ω–æ ${productsAdded}, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${productsSkipped}`);
            
            // 3. –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π
            log('info', 'üîß –ò—â—É –∑–∞–ø—á–∞—Å—Ç–∏ –≤ Firebase...');
            const partsSnapshot = await db.collection('parts').get();
            log('info', `üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø—á–∞—Å—Ç–µ–π: ${partsSnapshot.size}`);
            
            let partIndex = 0;
            let partsAdded = 0;
            let partsSkipped = 0;
            
            for (const partDoc of partsSnapshot.docs) {
                const partData = partDoc.data();
                
                const firebaseUserId = partData.userId || partData.user_id;
                const supabaseUserId = userMap[firebaseUserId];
                
                if (!supabaseUserId) {
                    log('warning', `‚ö†Ô∏è –ó–∞–ø—á–∞—Å—Ç—å "${partData.name}" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    partsSkipped++;
                    partIndex++;
                    continue;
                }
                
                // –ù–ï —É–∫–∞–∑—ã–≤–∞–µ–º id
                const supabasePart = {
                    user_id: supabaseUserId,
                    name: partData.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    product: partData.product || '',
                    source: partData.source || 'manual',
                    created_at: partData.createdAt?.toDate?.()?.toISOString() || new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from('parts')
                        .insert([supabasePart])
                        .select()
                        .single();
                    
                    if (error) {
                        log('warning', `‚ö†Ô∏è –ó–∞–ø—á–∞—Å—Ç—å "${partData.name}": ${error.message}`);
                        partsSkipped++;
                    } else {
                        log('success', `‚úÖ –ó–∞–ø—á–∞—Å—Ç—å: ${partData.name} (id: ${data.id})`);
                        partsAdded++;
                    }
                } catch (error) {
                    log('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—á–∞—Å—Ç–∏ "${partData.name}": ${error.message}`);
                    partsSkipped++;
                }
                
                partIndex++;
                updateProgress(80 + (partIndex / partsSnapshot.size * 18), 
                              `–ó–∞–ø—á–∞—Å—Ç–∏: ${partIndex}/${partsSnapshot.size}`);
            }
            
            log('info', `üìä –ó–∞–ø—á–∞—Å—Ç–∏: –¥–æ–±–∞–≤–ª–µ–Ω–æ ${partsAdded}, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${partsSkipped}`);
            
            // –ò—Ç–æ–≥–∏
            log('success', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('success', `üìä –ò–¢–û–ì–û –ú–ò–ì–†–ê–¶–ò–ò:`);
            log('success', `   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${Object.keys(userMap).length}`);
            log('success', `   üì¶ –¢–æ–≤–∞—Ä–æ–≤: ${productsAdded} –¥–æ–±–∞–≤–ª–µ–Ω–æ, ${productsSkipped} –ø—Ä–æ–ø—É—â–µ–Ω–æ`);
            log('success', `   üîß –ó–∞–ø—á–∞—Å—Ç–µ–π: ${partsAdded} –¥–æ–±–∞–≤–ª–µ–Ω–æ, ${partsSkipped} –ø—Ä–æ–ø—É—â–µ–Ω–æ`);
            log('success', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }
    </script>
</body>
</html>